{
  "id": "17f75827-0684-48f4-8747-61129c7e4198",
  "queryName": "Public Storage Account",
  "severity": "HIGH",
  "category": "Access Control",
  "descriptionText": "Storage Account should not be public to grant the principle of least privileges",
  "descriptionUrl": "https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account",
  "platform": "Terraform",
  "descriptionID": "88948514",
  "cloudProvider": "azure",
  "cwe": "285",
  "detailedDescriptionText": "Publicly accessible Azure Storage Accounts represent a high-security risk by potentially exposing sensitive data to unauthorized parties. This vulnerability occurs when network rules are configured to allow traffic from all IP addresses (0.0.0.0/0) or when the default_action is set to \"Allow\" without specific restrictions. Storage Accounts often contain critical business data, backups, configurations, and other sensitive assets that should be protected from unrestricted public access.\n\nVulnerable examples:\n```terraform\n# Storage account with network rules allowing 0.0.0.0/0 (all IPs)\nresource \"azurerm_storage_account\" \"vulnerable1\" {\n  name                     = \"storageaccountname\"\n  resource_group_name      = azurerm_resource_group.example.name\n  location                 = azurerm_resource_group.example.location\n  account_tier             = \"Standard\"\n  account_replication_type = \"LRS\"\n\n  network_rules {\n    default_action             = \"Deny\"\n    ip_rules                   = [\"0.0.0.0/0\"]    # Vulnerability: Allows access from any IP\n    virtual_network_subnet_ids = [azurerm_subnet.example.id]\n  }\n}\n\n# Storage account with default_action set to Allow (all traffic allowed by default)\nresource \"azurerm_storage_account\" \"vulnerable2\" {\n  name                     = \"storageaccountname\"\n  resource_group_name      = azurerm_resource_group.example.name\n  location                 = azurerm_resource_group.example.location\n  account_tier             = \"Standard\"\n  account_replication_type = \"LRS\"\n\n  network_rules {\n    default_action             = \"Allow\"    # Vulnerability: Allows all traffic by default\n    virtual_network_subnet_ids = [azurerm_subnet.example.id]\n  }\n}\n\n# Storage account network rules with unrestricted access\nresource \"azurerm_storage_account_network_rules\" \"vulnerable3\" {\n  resource_group_name      = azurerm_resource_group.test.name\n  storage_account_name     = azurerm_storage_account.test.name\n  default_action           = \"Allow\"    # Vulnerability: Allows all traffic by default\n  virtual_network_subnet_ids = [azurerm_subnet.test.id]\n  bypass                   = [\"Metrics\"]\n}\n```\n\nSecure examples:\n```terraform\n# Storage account with restricted network rules\nresource \"azurerm_storage_account\" \"secure\" {\n  name                     = \"storageaccountname\"\n  resource_group_name      = azurerm_resource_group.example.name\n  location                 = azurerm_resource_group.example.location\n  account_tier             = \"Standard\"\n  account_replication_type = \"LRS\"\n\n  network_rules {\n    default_action             = \"Deny\"           # Secure: Denies all traffic by default\n    ip_rules                   = [\"100.0.0.1\"]    # Secure: Restricts to specific IP\n    virtual_network_subnet_ids = [azurerm_subnet.example.id]\n  }\n}\n\n# Storage account network rules with proper restrictions\nresource \"azurerm_storage_account_network_rules\" \"secure\" {\n  resource_group_name      = azurerm_resource_group.test.name\n  storage_account_name     = azurerm_storage_account.test.name\n  default_action           = \"Deny\"             # Secure: Denies all traffic by default\n  ip_rules                 = [\"127.0.0.1\"]      # Secure: Restricts to specific IP\n  virtual_network_subnet_ids = [azurerm_subnet.test.id]\n  bypass                   = [\"Metrics\"]\n}\n```\n\nMitigation strategies:\n1. Always set default_action to \"Deny\" in network_rules to block all traffic by default\n2. Avoid using 0.0.0.0/0 in ip_rules as it allows access from any IP address\n3. Specify only the necessary IP addresses or ranges that need access\n4. Use Virtual Network Service Endpoints to restrict storage access to specific Azure VNets\n5. Implement Azure Private Link for completely private access to storage\n6. Enable Azure Storage firewalls to restrict traffic based on IP address\n7. Use Shared Access Signatures (SAS) with appropriate time limits and permissions\n8. Configure storage account access keys to be rotated regularly\n9. Enable Azure Defender for Storage for advanced threat protection\n10. Use diagnostic logging to monitor access patterns and potential security issues"
}